---
name: Nightly Compatibility Check

'on':
  schedule:
    # Run every night at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_dev_branch:
        description: 'Test against Home Assistant dev branch'
        type: boolean
        default: true
      send_notification:
        description: 'Create issue on failure'
        type: boolean
        default: true

permissions:
  contents: read
  issues: write

jobs:
  test-latest-stable:
    name: Test Against Latest HA Stable
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Get Latest Home Assistant Version
        id: ha-version
        run: |
          echo "Fetching latest Home Assistant version..."

          # Get latest from PyPI (most reliable)
          PYPI_VERSION=$(curl -s https://pypi.org/pypi/homeassistant/json | jq -r '.info.version')
          echo "PyPI latest: $PYPI_VERSION"

          # Also check GitHub for reference
          GITHUB_VERSION=$(curl -s https://api.github.com/repos/home-assistant/core/releases/latest | jq -r '.tag_name')
          echo "GitHub latest: $GITHUB_VERSION"

          # Use PyPI version (it's the source of truth)
          LATEST_VERSION=$PYPI_VERSION

          # Get Python requirement
          PY_REQ=$(curl -s https://pypi.org/pypi/homeassistant/json | jq -r '.info.requires_python')
          echo "Python requirement: $PY_REQ"

          # Determine Python version to use
          if [[ "$PY_REQ" == *"3.13"* ]]; then
            PYTHON_VERSION="3.13"
          else
            PYTHON_VERSION="3.12"
          fi

          echo "✨ Latest HA version: $LATEST_VERSION"
          echo "✨ Using Python: $PYTHON_VERSION"

          {
            echo "version=$LATEST_VERSION"
            echo "github_version=$GITHUB_VERSION"
            echo "pypi_version=$PYPI_VERSION"
            echo "python_version=$PYTHON_VERSION"
            echo "python_requirement=$PY_REQ"
          } >> "$GITHUB_OUTPUT"

      - name: Set up Python ${{ steps.ha-version.outputs.python_version }}
        uses: actions/setup-python@v6.0.0
        with:
          python-version: ${{ steps.ha-version.outputs.python_version }}
          cache: 'pip'

      - name: Install Latest Home Assistant
        run: |
          python -m pip install --upgrade pip
          echo "Installing Home Assistant ${{ steps.ha-version.outputs.version }}..."
          pip install homeassistant==${{ steps.ha-version.outputs.version }}
          pip install -r custom_components/csnet_home/requirements-dev.txt

          # Verify installation
          python -c "from homeassistant.const import __version__; print(f'✅ Installed: {__version__}')"

      - name: Run Tests Against Latest Stable
        id: test-stable
        run: |
          echo "Running tests against HA ${{ steps.ha-version.outputs.version }}..."
          pytest tests/ -v --tb=short
        continue-on-error: true

      - name: Store Results
        run: |
          {
            echo "## Latest Stable Test Results"
            echo ""
            echo "- **Version Tested**: ${{ steps.ha-version.outputs.version }}"
            echo "- **GitHub Latest**: ${{ steps.ha-version.outputs.github_version }}"
            echo "- **PyPI Latest**: ${{ steps.ha-version.outputs.pypi_version }}"
            echo ""
          } >> results.txt

          if [ "${{ steps.test-stable.outcome }}" == "success" ]; then
            echo "✅ Tests passed with HA ${{ steps.ha-version.outputs.version }}" >> results.txt
            echo "status=success" >> "$GITHUB_ENV"
          else
            echo "❌ Tests failed with HA ${{ steps.ha-version.outputs.version }}" >> results.txt
            echo "status=failure" >> "$GITHUB_ENV"
          fi

          cat results.txt

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: latest-stable-results
          path: results.txt
          retention-days: 30

  test-dev-branch:
    name: Test Against HA Dev Branch
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.test_dev_branch)
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install Home Assistant Dev
        id: install-dev
        run: |
          echo "Installing Home Assistant dev branch..."
          python -m pip install --upgrade pip
          pip install git+https://github.com/home-assistant/core.git@dev || {
            echo "⚠️ Failed to install HA dev branch - may be temporarily broken"
            echo "dev_install_failed=true" >> "$GITHUB_ENV"
            exit 0
          }
          pip install -r custom_components/csnet_home/requirements-dev.txt
        continue-on-error: true

      - name: Run Tests Against Dev
        id: test-dev
        if: env.dev_install_failed != 'true'
        run: |
          echo "Running tests against HA dev branch..."
          pytest tests/ -v --tb=short
        continue-on-error: true

      - name: Store Dev Results
        if: env.dev_install_failed != 'true'
        run: |
          if [ "${{ steps.test-dev.outcome }}" == "success" ]; then
            echo "✅ Tests passed with HA dev branch" >> dev-results.txt
            echo "dev_status=success" >> "$GITHUB_ENV"
          else
            echo "❌ Tests failed with HA dev branch" >> dev-results.txt
            echo "dev_status=failure" >> "$GITHUB_ENV"
            echo "This may indicate upcoming breaking changes in Home Assistant" >> dev-results.txt
          fi

      - name: Upload Dev Results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: dev-test-results
          path: dev-results.txt
          retention-days: 30

  get-versions-to-test:
    name: Get HA Versions to Test
    runs-on: ubuntu-latest
    outputs:
      versions_matrix: ${{ steps.fetch-versions.outputs.versions_matrix }}
      latest_version: ${{ steps.fetch-versions.outputs.latest_version }}
    steps:
      - name: Fetch Recent Stable Versions
        id: fetch-versions
        run: |
          echo "Fetching recent stable Home Assistant versions from PyPI..."

          # Get current year and month
          CURRENT_YEAR=$(date +%Y)
          CURRENT_MONTH=$(date +%-m)  # Remove leading zero

          echo "Current date: $CURRENT_YEAR.$CURRENT_MONTH"
          echo "Will test last 4 months of releases"

          # Get all stable versions (current and previous year if needed)
          ALL_VERSIONS=$(curl -s https://pypi.org/pypi/homeassistant/json | \
            jq -r '.releases | keys | .[]' | \
            grep -E '^20[0-9]{2}\.[0-9]+\.[0-9]+$' | \
            grep -v 'b' | \
            sort -V)

          # Group by month and get the latest patch version from each of the last 4 months
          VERSIONS=""
          for month in $(seq $((CURRENT_MONTH)) -1 $((CURRENT_MONTH - 3))); do
            if [ "$month" -lt 1 ]; then
              # Handle year boundary (e.g., Jan 2026 looking back to Nov/Dec 2025)
              PREV_YEAR=$((CURRENT_YEAR - 1))
              month=$((month + 12))
              LATEST=$(echo "$ALL_VERSIONS" | grep "^${PREV_YEAR}\.${month}\." | tail -1)
            else
              LATEST=$(echo "$ALL_VERSIONS" | grep "^${CURRENT_YEAR}\.${month}\." | tail -1)
            fi

            if [ -n "$LATEST" ]; then
              echo "  Month $month: $LATEST"
              VERSIONS="${VERSIONS}${LATEST}"$'\n'
            fi
          done

          # Remove trailing newline and sort
          VERSIONS=$(echo "$VERSIONS" | grep -v '^$' | sort -V)

          echo ""
          echo "Selected versions for testing:"
          echo "$VERSIONS"

          # Get the latest version
          LATEST=$(echo "$VERSIONS" | tail -1)
          echo "Latest version: $LATEST"

          # Create JSON array
          VERSIONS_JSON=$(echo "$VERSIONS" | jq -R -s -c 'split("\n") | map(select(length > 0))')

          # For each version, get Python requirement
          echo ""
          echo "Python requirements:"
          for v in $(echo "$VERSIONS_JSON" | jq -r '.[]'); do
            PY_REQ=$(curl -s "https://pypi.org/pypi/homeassistant/$v/json" \
              | jq -r '.info.requires_python // "unknown"')
            echo "  $v: Python $PY_REQ"
          done

          {
            echo "versions_matrix=$VERSIONS_JSON"
            echo "latest_version=$LATEST"
          } >> "$GITHUB_OUTPUT"

  smoke-test-multiple-versions:
    name: Smoke Test - HA ${{ matrix.version }}
    runs-on: ubuntu-latest
    needs: get-versions-to-test
    continue-on-error: true
    strategy:
      matrix:
        version: ${{ fromJson(needs.get-versions-to-test.outputs.versions_matrix) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Determine Python Version
        id: python-version
        run: |
          VERSION="${{ matrix.version }}"

          # Get Python requirement for this HA version
          PY_REQ=$(curl -s https://pypi.org/pypi/homeassistant/$VERSION/json \
            | jq -r '.info.requires_python // ">=3.12.0"')
          echo "HA $VERSION requires: $PY_REQ"

          # Map requirement to Python version to install
          # HA 2025.6+ requires Python 3.13.2+
          # HA 2024.12-2025.5 requires Python 3.12+
          if [[ "$PY_REQ" == *"3.13"* ]]; then
            PYTHON_VERSION="3.13"
          else
            PYTHON_VERSION="3.12"
          fi

          echo "Using Python version: $PYTHON_VERSION"
          echo "python_version=$PYTHON_VERSION" >> "$GITHUB_OUTPUT"

      - name: Set up Python ${{ steps.python-version.outputs.python_version }}
        uses: actions/setup-python@v6.0.0
        with:
          python-version: ${{ steps.python-version.outputs.python_version }}

      - name: Install Home Assistant ${{ matrix.version }}
        id: install-ha
        run: |
          python -m pip install --upgrade pip

          # Try to install specific version
          if pip install homeassistant==${{ matrix.version }}; then
            echo "✅ Successfully installed HA ${{ matrix.version }}"
            echo "install_success=true" >> "$GITHUB_ENV"
          else
            echo "❌ Failed to install HA ${{ matrix.version }}"
            echo "This version may not exist or may have dependency conflicts"
            echo "install_success=false" >> "$GITHUB_ENV"
            exit 0
          fi

          pip install -r custom_components/csnet_home/requirements.txt
        continue-on-error: true

      - name: Quick Import Test
        id: import-test
        if: env.install_success == 'true'
        run: |
          python << 'EOF'
          import sys
          sys.path.insert(0, '.')

          try:
              from custom_components.csnet_home import api, climate, sensor, water_heater
              from homeassistant.const import __version__ as ha_version
              print(f"✅ All modules imported successfully")
              print(f"   Tested with HA version: {ha_version}")
              print(f"   Matrix version: ${{ matrix.version }}")
          except Exception as e:
              print(f"❌ Import failed: {e}")
              sys.exit(1)
          EOF
        continue-on-error: true

      - name: Record Test Result
        if: always()
        run: |
          if [ "${{ env.install_success }}" == "false" ]; then
            echo "⏭️ HA ${{ matrix.version }}: SKIPPED (version not available)" >> smoke-results.txt
          elif [ "${{ steps.import-test.outcome }}" == "success" ]; then
            echo "✅ HA ${{ matrix.version }}: PASSED" >> smoke-results.txt
          elif [ "${{ steps.import-test.outcome }}" == "skipped" ]; then
            echo "⏭️ HA ${{ matrix.version }}: SKIPPED (install failed)" >> smoke-results.txt
          else
            echo "❌ HA ${{ matrix.version }}: FAILED" >> smoke-results.txt
          fi

      - name: Upload Smoke Test Results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: smoke-test-${{ matrix.version }}
          path: smoke-results.txt
          retention-days: 30

  report:
    name: Generate Compatibility Report
    runs-on: ubuntu-latest
    needs: [test-latest-stable, test-dev-branch, get-versions-to-test, smoke-test-multiple-versions]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Download Test Results
        uses: actions/download-artifact@v6
        with:
          pattern: '*-results*'
          path: artifacts
        continue-on-error: true

      - name: Generate Report
        run: |
          {
            echo "# 🔍 Nightly Compatibility Check Report"
            echo ""
            echo "**Date**: $(date '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "## Versions Tested"
            echo ""
            echo "- **Latest Stable**: ${{ needs.get-versions-to-test.outputs.latest_version }} 🔥"
            VERSIONS=$(echo '${{ needs.get-versions-to-test.outputs.versions_matrix }}' \
              | jq -r 'join(", ")')
            echo "- **Recent Versions**: $VERSIONS"
            echo "- **Dev Branch**: Latest development version"
            echo ""
            echo "_Note: Tests dynamically against recent stable HA releases" \
              "with appropriate Python versions_"
            echo ""
            echo "## Test Results"
            echo ""
          } > report.md

          # Latest stable results
          LATEST_VERSION="${{ needs.get-versions-to-test.outputs.latest_version }}"
          if [ "${{ needs.test-latest-stable.result }}" == "success" ]; then
            echo "✅ **Latest Stable HA** ($LATEST_VERSION): Tests Passed" >> report.md
          else
            echo "❌ **Latest Stable HA** ($LATEST_VERSION): Tests Failed" >> report.md
          fi

          # Dev branch results
          if [ "${{ needs.test-dev-branch.result }}" == "success" ]; then
            echo "✅ **HA Dev Branch**: Tests Passed" >> report.md
          elif [ "${{ needs.test-dev-branch.result }}" == "failure" ]; then
            echo "⚠️ **HA Dev Branch**: Tests Failed (may indicate upcoming breaking changes)" >> report.md
          else
            echo "⏭️ **HA Dev Branch**: Skipped or installation failed" >> report.md
          fi

          # Smoke tests
          if [ "${{ needs.smoke-test-multiple-versions.result }}" == "success" ]; then
            echo "✅ **Multi-Version Smoke Tests**: All Passed" >> report.md
            echo "   (including latest $LATEST_VERSION)" >> report.md
          else
            echo "⚠️ **Multi-Version Smoke Tests**: Some versions failed" >> report.md
          fi

          # Show individual smoke test results if available
          if [ -d "artifacts" ]; then
            {
              echo ""
              echo "### Detailed Smoke Test Results"
              echo ""
            } >> report.md
            find artifacts -name "smoke-results.txt" -exec cat {} \; \
              >> report.md 2>/dev/null || \
              echo "No detailed results available" >> report.md
          fi

          {
            echo ""
            echo "## Recommendations"
            echo ""
          } >> report.md

          if [ "${{ needs.test-dev-branch.result }}" == "failure" ]; then
            {
              echo "- 🔧 Review upcoming Home Assistant changes"
              echo "- 📝 Check HA dev branch changelog for breaking changes"
              echo "- 🛠️ Consider updating integration code proactively"
            } >> report.md
          elif [ "${{ needs.test-latest-stable.result }}" == "failure" ]; then
            {
              echo "- 🚨 **Critical**: Integration failing with latest stable HA version!"
              echo "- 🔧 Immediate investigation recommended"
              echo "- 📝 Check release notes for breaking changes"
            } >> report.md
          else
            {
              echo "- ✨ Integration appears compatible with all tested HA versions"
              echo "- 🎉 Including the absolute latest release ($LATEST_VERSION)"
              echo "- 📊 Continue monitoring for changes"
            } >> report.md
          fi

          cat report.md

      - name: Upload Report
        uses: actions/upload-artifact@v5
        with:
          name: compatibility-report-${{ github.run_number }}
          path: report.md
          retention-days: 90

      - name: Add to Step Summary
        if: always()
        run: |
          cat report.md >> "$GITHUB_STEP_SUMMARY"

      - name: Create Issue on Failure
        if: >-
          failure() &&
          (github.event_name == 'schedule' ||
           (github.event_name == 'workflow_dispatch' && inputs.send_notification))
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('report.md', 'utf8');

            // Check if there's already an open compatibility issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'compatibility,automated'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Compatibility Check Failed')
            );

            if (existingIssue) {
              // Update existing issue
              const runUrl = `${context.payload.repository.html_url}/actions/runs/${context.runId}`;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## Update: ${new Date().toISOString()}\n\n${report}\n\n[View workflow run](${runUrl})`
              });
            } else {
              // Create new issue
              const runUrl = `${context.payload.repository.html_url}/actions/runs/${context.runId}`;
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '🚨 Nightly Compatibility Check Failed',
                body: `${report}\n\n[View workflow run](${runUrl})`,
                labels: ['compatibility', 'automated', 'needs-investigation']
              });
            }

      - name: Comment on Success After Previous Failure
        if: success() && github.event_name == 'schedule'
        uses: actions/github-script@v8
        continue-on-error: true
        with:
          script: |
            // Check for open compatibility issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'compatibility,automated'
            });

            const compatIssue = issues.data.find(issue =>
              issue.title.includes('Compatibility Check Failed')
            );

            if (compatIssue) {
              const successMsg = '✅ Compatibility check is now passing! ' +
                'The issues have been resolved.\n\n' +
                'Consider closing this issue if all tests are stable.';
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: compatIssue.number,
                body: successMsg
              });
            }
